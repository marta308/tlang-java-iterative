<!-- Targets for working from terminal window:
       build (default) - generates java files and compiles them
       clean           - removes all generated files and class files
     Targets for working from Eclipse:
       gen             - generates java files
       genClean        - removes all generated files and their class files
 -->

<project name="Compiler" basedir=".">

  <!-- "package" is the directory where generated files will be stored -->
  <property name="package" value="AST"/>

  <!-- "tools" is the directory where generators and libraries are located. -->
  <property name="tools" value="src/tools"/>
    
  <!-- "jflex" is an ant task class for the scanner generator in JFlex.jar -->
  <taskdef name="jflex" classname="JFlex.anttask.JFlexTask" classpath="${tools}/JFlex.jar"/>

  <!-- "beaver" is an ant task class for the parser generator in beaver.jar -->
  <taskdef name="beaver" classname="beaver.comp.run.AntTask" classpath="${tools}/beaver.jar"/>

  <!-- "jastadd" is an ant task class in jastadd2.jar -->
  <taskdef classname="jastadd.JastAddTask" name="jastadd" classpath="${tools}/jastadd2.jar" />

  <!-- TARGET build: compile sources -->
  <target name="build_iter" depends="gen_iter">
    <!-- compile all java files in srcdir and recursively in subdirectories -->
    <javac debug="true" nowarn="true" srcdir="src;src-gen" classpath=".:${tools}/beaver-rt.jar:${tools}/junit.jar"
        includeantruntime="false"/>
  </target>

  <!-- TARGET gen: generate source files -->
  <target name="gen_iter" depends="TLANGscanner,TLANGparser,COMPLANGscanner,COMPLANGparser">
    <!-- create a directory for the generated files -->
    <mkdir dir="src-gen/${package}"/>
    <!-- run jastadd to generate AST files -->
    <jastadd package="${package}" beaver="true" outdir="${basedir}/src-gen" lineColumnNumbers="true">
      <fileset dir="src">
        <include name="**/spec/*.ast"/>
        <include name="**/spec/*.jrag"/>
        <include name="**/spec/*.jadd"/>
      </fileset>
    </jastadd>
  </target>
	
	<!-- TARGET build: compile sources -->
	  <target name="build_decl" depends="gen_decl">
	    <!-- compile all java files in srcdir and recursively in subdirectories -->
	    <javac debug="true" nowarn="true" srcdir="src;src-gen" classpath=".:${tools}/beaver-rt.jar:${tools}/junit.jar"
	        includeantruntime="false"/>
	  </target>

	  <!-- TARGET gen: generate source files -->
	  <target name="gen_decl" depends="TLANGscanner,TLANGparser,COMPLANGscanner,COMPLANGparser">
	    <!-- create a directory for the generated files -->
	    <mkdir dir="src-gen/${package}"/>
	    <!-- run jastadd to generate AST files -->
	    <jastadd rewrite="true" package="${package}" beaver="true" outdir="${basedir}/src-gen" lineColumnNumbers="true">
	      <fileset dir="src">
	        <include name="**/spec/*.ast"/>
	        <include name="**/spec/*.jrag"/>
	        <include name="**/spec/*.jadd"/>
	      </fileset>
	    </jastadd>
	  </target>

  <target name="TLANGscanner">
    <!-- generate the scanner, translating .flex to .java -->
    <jflex file="src/spec/TLangScanner.flex" outdir="src-gen/${package}" nobak="yes"/>
  </target>
	
	<target name="COMPLANGscanner">
	    <!-- generate the scanner, translating .flex to .java -->
	    <jflex file="src/spec/CompLangScanner.flex" outdir="src-gen/${package}" nobak="yes"/>
	  </target>

  <target name="TLANGparser">
    <!-- preprocess the parser, translating .parser to .beaver -->
    <java 
        classpath="${tools}/JastAddParser.jar:${tools}/beaver-rt.jar" 
        classname="Main" 
        fork="true">
      <arg value="--no-beaver-symbol" />
      <arg value="src/spec/TLangParser.parser" />
      <arg value="src-gen/${package}/TLangParser.beaver" />
    </java>
    <!-- generate the parser, translating .beaver to .java -->
    <beaver file="src-gen/${package}/TLangParser.beaver" terminalNames="yes" compress="no" useSwitch="yes"/>
  </target>
	
	<target name="COMPLANGparser">
	    <!-- preprocess the parser, translating .parser to .beaver -->
	    <java 
	        classpath="${tools}/JastAddParser.jar:${tools}/beaver-rt.jar" 
	        classname="Main" 
	        fork="true">
	      <arg value="--no-beaver-symbol" />
	      <arg value="src/spec/CompLangParser.parser" />
	      <arg value="src-gen/${package}/CompLangParser.beaver" />
	    </java>
	    <!-- generate the parser, translating .beaver to .java -->
	    <beaver file="src-gen/${package}/CompLangParser.beaver" terminalNames="yes" compress="no" useSwitch="yes"/>
	  </target>

  <!-- Remove generated source files and .class files -->
  <target name="clean" depends="cleanGen">
    <!-- Delete all classfiles in dir and recursively in subdirectories -->
    <delete>
      <fileset dir="." includes="**/*.class"/>
    </delete>
  </target>

  <!-- Remove generated source files -->
  <target name="cleanGen">
    <delete dir="src-gen/${package}"/>
  </target>

  
</project>
